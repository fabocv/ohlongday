# üìò BDP ‚Äî Documento T√©cnico (v1.0)
**Bienestar Data Project (BDP)** ¬∑ Definiciones de variables, normalizaci√≥n, EMA, modelos (‚â•30 registros) e √≠ndices compuestos (ansiedad, hipoman√≠a, etc.).  
> **Aviso importante:** Todo lo que sigue son **estimaciones proxy** para apoyo personal y terap√©utico. **No son diagn√≥sticos cl√≠nicos.**

---

## 0) Alcance e implementaci√≥n actual
- **Captura de datos:** Google Forms ‚Üí Google Sheets/CSV (por rapidez y menor fricci√≥n).
- **Procesamiento:** Python (pandas, numpy, scipy, scikit-learn opcional), scripts modulares.
- **Salida:** HTML/PDF (reportes ‚Äúcoach‚Äù), m√©tricas y gr√°ficos con interpretaci√≥n t√©cnica + humana.
- **Frecuencia:** 1‚Äì3 registros d√≠a (ideal: ma√±ana/tarde/noche) o 1 consolidado diario.

---

## 1) Esquema de datos (columnas crudas)
**M√≠nimo recomendado** (nombres orientativos, ajusta a tu CSV real):

### 1.1 N√∫cleo emocional / cognitivo
- `animo` (0‚Äì10)
- `activacion` (0‚Äì10)
- `conexion` (0‚Äì10)
- `proposito` (0‚Äì10)
- `claridad` (0‚Äì10)
- `estres` (0‚Äì10)
- `ansiedad` (0‚Äì10, si existe)
- `irritabilidad` (0‚Äì10, si existe)

### 1.2 Sue√±o / ritmos
- `hora_dormir` (HH:MM)
- `hora_despertar` (`hora_DSPT`) (HH:MM)
- `sueno_calidad` (0‚Äì10)
- `despertares_nocturnos` (`DSPTes_nocturnos`) (0,1,2,3‚Ä¶)

### 1.3 Movimiento y fisiolog√≠a
- `mov_intensidad` (0‚Äì10)
- `tiempo_ejercicio` (min)
- `siesta_min` (min)
- `glicemia` (mg/dL, si aplica)

### 1.4 H√°bitos / consumo
- `cafe_cucharaditas` (‚âà 1 cdita ~ 60‚Äì80 mg cafe√≠na)
- `cafe_ultima_hora` (bool/0‚Äì1)
- `alcohol_ud` (unidades est√°ndar)
- `alcohol_ultima_hora` (bool/0‚Äì1)
- `agua_litros` (L)
- `otras_sustancias` (texto/opcional)
- `medicacion_tipo` (texto)
- `medicacion_tomada` (bool/0‚Äì1)

### 1.5 Contexto y sociales
- `interacciones_calidad` (‚àí10..+10 o 0‚Äì10; definir)
- `interacciones_significativas` (conteo 0,1,2‚Ä¶)
- `tiempo_pantalla_noche_min` (min)
- `juego_en_dispositivo_min` (min)
- `juego_en_persona_min` (min)
- `exposicion_sol_manana_min` (min)
- `espiritual` (lista de etiquetas)
- `tags` / `eventos_estresores` / `notas` (con **c√≥digos personales**: ej. `ABL01`, `FJJ`)

### 1.6 Metadatos
- `fecha` (YYYY-MM-DD), `hora` (HH:MM), `bloque` (`ma√±ana`/`tarde`/`noche`/`dia`)

---

## 2) Limpieza y tipado
1. **Parseo temporal:** convertir `fecha` y `hora` a `datetime`; derivar `bloque` si falta:
   - `ma√±ana`: 05:00‚Äì11:59; `tarde`: 12:00‚Äì18:59; `noche`: 19:00‚Äì04:59.
2. **Casting num√©rico:** forzar columnas 0‚Äì10 y minutos a `float`.
3. **Winsorizaci√≥n suave:** recortar p1/p99 en m√©tricas con outliers (p.ej. `tiempo_pantalla_noche_min`).
4. **Imputaci√≥n m√≠nima:** **LOCF** (last observation carried forward) con tope de 2 d√≠as; si falla, usar mediana personal.
5. **Flags de faltantes:** crear columnas `_isna` por variable cr√≠tica para trazabilidad.

---

## 3) Variables intermedias (derivadas)

### 3.1 Sue√±o y descanso
- **Duraci√≥n de sue√±o (h):**  
  Si `hora_dormir` > `hora_despertar`, sumar 24h al despertar.  
  $$ \text{sueno\_duracion\_h} = \frac{\text{despertar} - \text{dormir}}{60}$$ 
- **D√©ficit de sue√±o (h):** respecto a objetivo personal (ej. 7.5 h).  
  $$ \text{sueno\_deficit_h} = 7.5 - \text{sueno\_duracion\_h}$$ 
- **Indicador de fragmentaci√≥n:**  
  $$ \text{sueno\_fragmentacion} = \text{scale}( \text{despertares\_nocturnos} )$$ 
- **√çndice de sue√±o compuesto (0‚Äì10):** pondera calidad, duraci√≥n y fragmentaci√≥n:  
  $$ I_{sueno} = 0.5\cdot \text{norm}(\text{sueno\_calidad}) + 0.35\cdot \text{norm}(\text{sueno\_duracion\_h}) - 0.15\cdot \text{norm}(\text{sueno\_fragmentacion})$$ 

### 3.2 Movimiento y energ√≠a
- **Carga de actividad (AU):**  
  $$ \text{actividad\_carga} = \text{mov\_intensidad}\times \sqrt{\text{tiempo\_ejercicio (min)}}$$ 
- **Recuperaci√≥n r√°pida (proxy):** si `siesta_min`>0 y `actividad_carga` alta ‚Üí +recuperaci√≥n.
- **√çndice metab√≥lico/energ√≠a (0‚Äì10):**  
  $$ I_{energia} = 0.45\cdot \text{norm}(\text{actividad\_carga}) + 0.35\cdot \text{norm}(I_{sueno}) + 0.20\cdot \text{norm}(-|\text{glicemia}-\mu_{g}|),$$ 
  donde $$ \(\mu_{g}\)$$  es el **rango objetivo personal** (p.ej. 80‚Äì110 mg/dL en ayunas). Se penaliza desviaci√≥n absoluta.

### 3.3 Estimulantes / depresores
- **Cafe√≠na estimada (mg):**  
  $$ \text{cafeina\_mg} \approx 75 \times \text{cafe\_cucharaditas}$$ 
- **Alcohol reciente (flag):** `alcohol_ultima_hora` o `alcohol_ud`‚â•1.
- **Carga psicoactiva (proxy 0‚Äì10):**
  $$ \text{psicoactiva} = \text{scale}\big( \text{cafeina\_mg} + 120\cdot\text{alcohol\_ud} \big)$$ 

### 3.4 Sociales, pantalla y espiritualidad
- **Balance social (‚àí1..+1):**  
  $$ \text{social\_balance} = \text{scale}(\text{interacciones\_calidad}) + 0.1\cdot \text{scale}(\text{interacciones\_significativas})$$ 
- **Carga nocturna de pantalla (0‚Äì10):** `scale(tiempo_pantalla_noche_min)`.
- **Juego digital / presencial:** dos canales (`juego_en_dispositivo_min`, `juego_en_persona_min`) para contrastar regulaciones opuestas.
- **Pr√°ctica espiritual (0‚Äì10):** frecuencia/etiquetas ‚Üí conteo o minutos ‚Üí `norm`.

---

## 4) Normalizaci√≥n
> Buscamos comparabilidad **intra-persona** (baseline personal).

### 4.1 Z-score cl√°sico (si n‚â•20 v√°lidos)
$$ z(x_t) = \frac{x_t - \mu_x}{\sigma\_x}$$ 
- \(\mu_x\), \(\sigma\_x\) = media y desv√≠o **personales** (√∫ltimos 60‚Äì90 d√≠as si existen).

### 4.2 Z robusto (si n<20 o outliers)
$$ z_r(x_t) = \frac{x_t - \text{mediana}(x)}{1.4826\cdot \text{MAD}(x)}$$ 
- **Winsorizar** p05‚Äìp95 antes si hay extremos.

### 4.3 `norm(¬∑)` y `scale(¬∑)`
- `norm`: llevar a 0‚Äì10 post-z con clip (ej.: `norm = clip(5 + 2*z, 0, 10)`).
- `scale`: estandarizar a 0‚Äì10 con cuantiles personales (p10‚Üí2, p90‚Üí8).

---

## 5) Suavizado EMA (Œ±‚âà0.30, lookback‚âà14)
$$ S_t = \alpha\cdot x_t + (1-\alpha)\cdot S_{t-1}$$ 
- **Warm-up:** mostrar EMA solo si n ‚â• 7‚Äì10.  
- **Confianza EMA:**  
  $$ \text{conf}_{EMA}(t) = \min\left(1,\ \frac{n}{14}\right)\cdot \frac{1}{1 + \text{var}(x_{t-13..t})}$$ 
- **Bandas ‚ÄúCaution/Alert‚Äù:** cuantiles personales p20/p80 (o p15/p85).  
- **Autotune opcional:** grid‚Äêsearch \(\alpha\in[0.2,0.35]\), \(L\in[10,21]\) minimizando error 1-paso (MAE).

---

## 6) √çndices compuestos del BDP (d√≠a t)
> Vector **H-V-C-P-S‚Åª** (base te√≥rica del BDP).

$$ \begin{aligned}
H_t &= z(\text{animo}_t) \\
V_t &= z(\text{activacion}_t) + z(I_{sueno,t}) \\
C_t &= z(\text{conexion}_t) \\
P_t &= z(\text{proposito}_t) + z(\text{claridad}_t) \\
S_t^- &= -\,z(\text{estres}_t)
\end{aligned}$$ 

- **Bienestar compuesto (WB):**  
  $$ WB_t = w_H H_t + w_V V_t + w_C C_t + w_P P_t + w_{S^-} S_t^-$$ 
  **Pesos sugeridos (hip√≥tesis):** \(w_H=0.25,\ w_V=0.20,\ w_C=0.15,\ w_P=0.20,\ w_{S^-}=0.20\).  
  > Ajustables por validaci√≥n personal o aprendizaje (secci√≥n 8).

- **√çndice de Carga (Stress Load):**  
  $$ SL_t = z(\text{estres}_t) + 0.3\cdot \text{scale}(\text{eventos\_estresores}) + 0.2\cdot \text{scale}(\text{tiempo\_pantalla\_noche\_min})$$ 

- **√çndice Energ√©tico (Energy):** usar \(I_{energia}\) (3.2) y su z.

---

## 7) √çndices cl√≠nico-proxy (no diagn√≥sticos)

### 7.1 Ansiedad-proxy (AX)
$$ AX_t = 0.40\,z(\text{estres}_t) + 0.25\,z(\text{ansiedad}_t) + 0.15\,z_r(\text{irritabilidad}_t) + 0.10\,\text{scale}(\text{cafeina\_mg}_t) + 0.10\,\text{scale}(\text{despertares\_nocturnos}_t)$$ 
- **Lectura:** ‚ÜëAX sugiere activaci√≥n/hipervigilancia; revisar sue√±o, cafe√≠na y regulaci√≥n.

### 7.2 Hipoman√≠a-proxy (HYPO)
$$ \begin{aligned}
HYPO_t =\ & 0.35\,z(\text{activacion}_t) + 0.20\,z(\text{animo}_t) \\
& - 0.15\,\text{norm}(\text{sueno\_duracion\_h}_t) + 0.10\,\text{scale}(\text{cafeina\_mg}_t) \\
& + 0.10\,\text{scale}(\text{interacciones\_significativas}_t) + 0.10\,\text{scale}(\text{impulso\_nocturno}_t)
\end{aligned}$$ 
- `impulso_nocturno` ~ combinaci√≥n de `tiempo_pantalla_noche_min`, juego nocturno, compras/decisiones impulsivas (si etiqueta existe).
- **Lectura:** ‚ÜëHYPO sugiere patr√≥n de **alta activaci√≥n con menor descanso**.

### 7.3 Depresi√≥n-proxy (DEP)
$$ DEP_t = -0.35\,z(\text{animo}_t) - 0.20\,z(\text{activacion}_t) - 0.15\,z(\text{proposito}_t) - 0.10\,z(\text{claridad}_t) + 0.10\,\text{scale}(\text{sueno\_fragmentacion}_t) - 0.10\,\text{norm}(\text{autocuidado}_t)$$ 
- **Lectura:** ‚ÜëDEP sugiere **bajo tono emocional/energ√≠a** + trastornos de sue√±o.

> **Recordatorio:** Estos √≠ndices son **orientativos** y deben leerse con **contexto personal y cl√≠nico**.

---

## 8) Modelos cuando n ‚â• 30 registros
**Objetivo t√≠pico:** predecir \(WB_{t+1}\), \(H_{t+1}\) o \(AX_{t+1}\) para alertas y planificaci√≥n.

### 8.1 Ingenier√≠a de variables
- **Features base (t):** z y EMA de: `animo, activacion, claridad, proposito, conexion, estres`, `I_sueno`, `actividad_carga`, `cafeina_mg`, `alcohol_ud`, `AX_t`, `HYPO_t`, `DEP_t`, `social_balance`, `pantalla_noche`, `espiritual_score`.
- **Deltas:** \(x_t - x_{t-1}\) en claves (√°nimo, estr√©s, sue√±o, actividad).
- **Ventanas:** medias y varianzas m√≥viles (3,7,14 d√≠as).
- **Estacionales:** dummies por d√≠a de semana y bloque.

> **Evitar leakage:** solo usar informaci√≥n **hasta t** para predecir **t+1**.

### 8.2 Candidatos
1. **Baseline-EMA:** \( \hat{y}_{t+1} = S_t^{(y)} \)  
2. **Regresi√≥n Ridge/Lasso:** lineal y parsimoniosa (explicable).
3. **√Årboles (RandomForest/GBDT):** capturan no-linealidades; limitar profundidad (evitar overfit).
4. **Regresi√≥n robusta (Huber):** tolerante a outliers.

### 8.3 Selecci√≥n y validaci√≥n
- **CV** 5-fold temporal (bloques contiguos) o **walk-forward**.
- **M√©tricas:** MAE (principal), RMSE, MAPE (si procede).
- **Criterio de elecci√≥n:** modelo con **MAE m√≠nimo** y **estabilidad** (varianza baja entre folds).
- **Comparaci√≥n base:** mejora relativa sobre EMA ‚â• **10‚Äì15%** para justificar complejidad.

### 8.4 Importancias y explicabilidad
- **Lineales:** pesos estandarizados (coeficientes sobre z-features).
- **√Årboles:** importancia por ganancia; usar **SHAP** para casos.

---

## 9) Reglas de negocio y focos
- **Bandas y alertas:** si \(AX_t\) > p85 personal ‚Üí **Caution**; > p95 ‚Üí **Alert**.  
- **Reglas si/entonces (ejemplos):**  
  - Si `activacion_pre_salida ‚â• 7` y `sueno_deficit_h ‚â• 1` ‚Üí **evitar grupos grandes**.  
  - Si `pantalla_noche` p>90 dos d√≠as seguidos ‚Üí **‚Äúhigiene de sue√±o +30 min off-screen‚Äù**.  
  - Si `alcohol_ud ‚â• 2` ‚Üí sugerir **re-hidrataci√≥n** y **suave actividad** al d√≠a siguiente.

---

## 10) Salidas y columnas finales (ejemplo)
- **Series z y EMA:** `animo_z`, `animo_ema`, ‚Ä¶ (para todas las principales).  
- **Derivadas:** `sueno_duracion_h`, `sueno_deficit_h`, `actividad_carga`, `cafeina_mg`, `social_balance`, `pantalla_noche_scaled`, `espiritual_score`.  
- **√çndices:** `WB`, `SL` (Stress Load), `Energy`, `AX`, `HYPO`, `DEP`.  
- **Confianzas:** `conf_ema_animo`, `conf_ema_wb`.  
- **Alertas:** `flag_caution_ax`, `flag_alert_ax`, etc.  
- **Cards coach:** `stoic_day_card`, `hard_day_card`, `retro_now_card`, `week_trendly_card` (estructura JSON por card con `resumen_areas`, `drivers_pos/neg`, `mensajes`).

---

## 11) Pesos: hip√≥tesis y ajuste
- **Iniciales** (secci√≥n 6) basados en literatura general y heur√≠stica de regulaci√≥n.  
- **Ajuste personal:** optimizar \(w\) maximizando correlaci√≥n entre `WB` y **auto-rating semanal** (‚Äú¬øc√≥mo evaluaste tu semana?‚Äù 0‚Äì10), con **regularizaci√≥n L1** para evitar sobreajuste.  
- **Revisi√≥n trimestral:** recalcular z-scores con ventana m√≥vil y revalidar pesos.

---

## 12) Buenas pr√°cticas y notas
- **Estabilidad primero:** preferir **z robusto** en etapas tempranas.  
- **Separar ‚Äúproxies cl√≠nicos‚Äù del lenguaje cl√≠nico:** nomenclatura `*_proxy`.  
- **Trazabilidad:** conservar columnas `_isna`, `_winsorized`, `_imputed`.  
- **Privacidad:** c√≥digos personales en `tags/eventos_estresores/notas` **no se decodifican**, solo se analizan **patrones repetidos**.

---

## 13) Glosario r√°pido
- **z / z_r:** estandarizaci√≥n (cl√°sica / robusta).  
- **EMA:** media m√≥vil exponencial.  
- **WB:** bienestar compuesto.  
- **AX/HYPO/DEP:** √≠ndices **proxy** de ansiedad / hipoman√≠a / depresi√≥n.  
- **scale/norm:** mapeos a 0‚Äì10 por cuantiles o z a 0‚Äì10.  
- **LOCF:** imputaci√≥n por √∫ltimo valor observado.

---

## 14) Ejemplo de f√≥rmulas en bloque (copiable)
```text
# EMA gen√©rica
S_t = alpha * x_t + (1 - alpha) * S_{t-1}
alpha ‚âà 0.30, lookback ‚âà 14, warm-up ‚â• 7-10

# WB (pesos sugeridos)
WB_t = 0.25*H_t + 0.20*V_t + 0.15*C_t + 0.20*P_t + 0.20*S^-_t

# Ansiedad-proxy (AX)
AX_t = 0.40*z(estr√©s) + 0.25*z(ansiedad) + 0.15*zr(irritabilidad)
       + 0.10*scale(cafeina_mg) + 0.10*scale(despertares_nocturnos)
```

## 15) L√≠mites y futuros m√≥dulos

- Hormonas y marcadores biol√≥gicos: a√∫n no modelados (dopamina, serotonina, cortisol).

- Geometr√≠a social detallada: tama√±o grupo, ruido, alcohol, horario, duraci√≥n.

- Se√±ales som√°ticas r√°pidas (MTC/fisio): palpitaciones, calor vespertino, aftas, etc.

- Integraciones externas: wearables (sue√±o, HRV), apps mindfulness y actividad.

> **Cierre**: Este documento estandariza c√≥mo derivamos y suavizamos se√±ales, c√≥mo agregamos √≠ndices compuestos y c√≥mo comparamos modelos cuando existe historial suficiente (‚â•30). Todo est√° dise√±ado para preservar contexto personal, mantener explicabilidad y sostener una evoluci√≥n iterativa del BDP.